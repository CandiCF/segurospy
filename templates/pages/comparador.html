{% extends "base.html" %}

{% block content %}
<section class="comparador-page">
    <div class="container">
        <h1>Compara tu Seguro en 2 Minutos âœ¨</h1>
        <p class="subtitle">Encuentra el mejor precio entre mÃ¡s de 20 aseguradoras en la Sierra de Madrid</p>

        <div class="comparador-form-container">
            <!-- Paso 1: Tipo de seguro -->
            <div id="step-1" class="form-step active">
                <h3 style="text-align: center; margin-bottom: 2rem; color: #FF6B6B;">ğŸ’œ Â¿QuÃ© seguro necesitas?</h3>

                <div class="insurance-types">
                    <label class="insurance-type">
                        <input type="radio" name="tipo_seguro" value="hogar" required>
                        <div class="insurance-card">
                            <span class="icon">ğŸ </span>
                            <span class="name">Hogar</span>
                        </div>
                    </label>

                    <label class="insurance-type">
                        <input type="radio" name="tipo_seguro" value="auto">
                        <div class="insurance-card">
                            <span class="icon">ğŸš—</span>
                            <span class="name">Coche</span>
                        </div>
                    </label>

                    <label class="insurance-type">
                        <input type="radio" name="tipo_seguro" value="vida">
                        <div class="insurance-card">
                            <span class="icon">ğŸ’š</span>
                            <span class="name">Vida</span>
                        </div>
                    </label>

                    <label class="insurance-type">
                        <input type="radio" name="tipo_seguro" value="decesos">
                        <div class="insurance-card">
                            <span class="icon">ğŸ•Šï¸</span>
                            <span class="name">Decesos</span>
                        </div>
                    </label>

                    <label class="insurance-type">
                        <input type="radio" name="tipo_seguro" value="salud">
                        <div class="insurance-card">
                            <span class="icon">ğŸ¥</span>
                            <span class="name">Salud</span>
                        </div>
                    </label>

                    <label class="insurance-type">
                        <input type="radio" name="tipo_seguro" value="mascotas">
                        <div class="insurance-card">
                            <span class="icon">ğŸ¾</span>
                            <span class="name">Mascotas</span>
                        </div>
                    </label>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-primary btn-lg" onclick="nextStep(1)">
                        Continuar â†’
                    </button>
                </div>
            </div>

            <!-- Paso 2: Datos personales -->
            <div id="step-2" class="form-step" style="display: none;">
                <form id="comparador-form" class="contact-form" style="background: white;">
                    <h3 style="text-align: center; margin-bottom: 2rem; color: #FF6B6B;">ğŸ“ Tus datos de contacto</h3>

                    <input type="hidden" name="tipo_seguro" id="tipo_seguro_hidden">

                    <div class="form-group">
                        <label for="nombre">Nombre completo *</label>
                        <input type="text" id="nombre" name="nombre" required minlength="2" placeholder="Tu nombre">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required placeholder="tu@email.com">
                        </div>

                        <div class="form-group">
                            <label for="telefono">TelÃ©fono *</label>
                            <input type="tel" id="telefono" name="telefono" required minlength="9"
                                placeholder="612 345 678">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="localidad">Localidad *</label>
                        <select id="localidad" name="localidad" required>
                            <option value="">Selecciona tu localidad...</option>
                            <option value="Collado Villalba">â­ Collado Villalba</option>
                            <option value="Galapagar">ğŸ”ï¸ Galapagar</option>
                            <option value="Alpedrete">ğŸŒ² Alpedrete</option>
                            <option value="Torrelodones">ğŸ¡ Torrelodones</option>
                            <option value="Guadarrama">â›°ï¸ Guadarrama</option>
                            <option value="Los Molinos">ğŸï¸ Los Molinos</option>
                            <option value="Cercedilla">ğŸŒ¿ Cercedilla</option>
                            <option value="Moralzarzal">ğŸŒ³ Moralzarzal</option>
                            <option value="Navacerrada">ğŸ”ï¸ Navacerrada</option>
                            <option value="El Escorial">ğŸ° El Escorial</option>
                            <option value="Otra">ğŸ“ Otra localidad</option>
                        </select>
                    </div>

                    <div class="form-group checkbox">
                        <input type="checkbox" id="privacidad" name="privacidad" required>
                        <label for="privacidad">
                            He leÃ­do y acepto la <a href="/politica-privacidad" target="_blank">polÃ­tica de
                                privacidad</a> *
                        </label>
                    </div>

                    <div class="form-buttons">
                        <button type="button" class="btn btn-outline" onclick="prevStep(2)">
                            â† AtrÃ¡s
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            âœ¨ Obtener Presupuesto Gratis
                        </button>
                    </div>
                </form>
            </div>

            <!-- Paso 3: Ã‰xito -->
            <div id="step-3" class="form-step step-success" style="display: none;">
                <div class="success-icon">ğŸ‰</div>
                <h2 style="color: #FF6B6B; margin-bottom: 1rem;">Â¡Solicitud Recibida!</h2>
                <p style="font-size: 1.2rem; color: #636E72; margin-bottom: 2rem;">
                    Hemos recibido tu solicitud de presupuesto. Un asesor te contactarÃ¡ en menos de 24 horas.
                </p>

                <div class="summary-box" id="summary">
                    <!-- Se rellena con JavaScript -->
                </div>

                <p style="color: #FF69B4; font-weight: 600;">
                    ğŸ’œ Gracias por confiar en SegurosPy
                </p>

                <a href="/" class="btn btn-primary">â† Volver al Inicio</a>
            </div>

            <!-- Indicador de pasos -->
            <div class="step-indicator">
                <div class="step-dot active" id="dot-1">1</div>
                <div class="step-line"></div>
                <div class="step-dot" id="dot-2">2</div>
                <div class="step-line"></div>
                <div class="step-dot" id="dot-3">âœ“</div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
    let currentStep = 1;
    let selectedInsurance = '';

    function nextStep(step) {
        if (step === 1) {
            // Validar que se haya seleccionado un tipo de seguro
            const selected = document.querySelector('input[name="tipo_seguro"]:checked');
            if (!selected) {
                alert('Por favor, selecciona un tipo de seguro');
                return;
            }
            selectedInsurance = selected.value;
            document.getElementById('tipo_seguro_hidden').value = selectedInsurance;
        }

        document.getElementById(`step-${step}`).style.display = 'none';
        document.getElementById(`step-${step + 1}`).style.display = 'block';

        // Actualizar indicadores
        document.getElementById(`dot-${step}`).classList.remove('active');
        document.getElementById(`dot-${step}`).classList.add('completed');
        document.getElementById(`dot-${step + 1}`).classList.add('active');

        currentStep = step + 1;
    }

    function prevStep(step) {
        document.getElementById(`step-${step}`).style.display = 'none';
        document.getElementById(`step-${step - 1}`).style.display = 'block';

        // Actualizar indicadores
        document.getElementById(`dot-${step}`).classList.remove('active');
        document.getElementById(`dot-${step - 1}`).classList.remove('completed');
        document.getElementById(`dot-${step - 1}`).classList.add('active');

        currentStep = step - 1;
    }

    // Manejar envÃ­o del formulario
    document.getElementById('comparador-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ Enviando...';
        btn.disabled = true;

        const formData = {
            nombre: document.getElementById('nombre').value,
            email: document.getElementById('email').value,
            telefono: document.getElementById('telefono').value,
            tipo_seguro: document.getElementById('tipo_seguro_hidden').value,
            localidad: document.getElementById('localidad').value
        };

        try {
            const response = await fetch('/api/leads/comparador', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                // Mostrar resumen
                const insuranceNames = {
                    'hogar': 'ğŸ  Seguro de Hogar',
                    'auto': 'ğŸš— Seguro de Coche',
                    'vida': 'ğŸ’š Seguro de Vida',
                    'decesos': 'ğŸ•Šï¸ Seguro de Decesos',
                    'salud': 'ğŸ¥ Seguro de Salud',
                    'mascotas': 'ğŸ¾ Seguro de Mascotas'
                };

                document.getElementById('summary').innerHTML = `
                <p><strong>Tipo:</strong> ${insuranceNames[formData.tipo_seguro]}</p>
                <p><strong>Nombre:</strong> ${formData.nombre}</p>
                <p><strong>Localidad:</strong> ${formData.localidad}</p>
                <p><strong>TelÃ©fono:</strong> ${formData.telefono}</p>
            `;

                // Ir al paso 3
                nextStep(2);

                // Confetti
                createConfetti();
            } else {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('Error: ' + (data.detail || 'Ha ocurrido un error'));
            }
        } catch (error) {
            console.error('Error:', error);
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('Error al enviar el formulario. IntÃ©ntalo de nuevo.');
        }
    });

    // Confetti
    function createConfetti() {
        const colors = ['#FF6B6B', '#FF69B4', '#32CD32', '#40E0D0', '#FFD93D', '#9B59B6'];
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
            position: fixed;
            width: ${5 + Math.random() * 10}px;
            height: ${5 + Math.random() * 10}px;
            background: ${colors[Math.floor(Math.random() * colors.length)]};
            left: ${Math.random() * 100}vw;
            top: -20px;
            border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
            pointer-events: none;
            z-index: 9999;
            animation: confettiFall ${2 + Math.random() * 3}s linear forwards;
        `;
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 5000);
        }
    }

    // AÃ±adir keyframes
    const style = document.createElement('style');
    style.textContent = `
    @keyframes confettiFall {
        to {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }
`;
    document.head.appendChild(style);
</script>
{% endblock %}